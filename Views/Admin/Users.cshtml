@model IEnumerable<manyasligida.Models.User>
@{
    ViewData["Title"] = "Kullanıcı Yönetimi";
    Layout = "_AdminLayout";
}

<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Kullanıcı Yönetimi</h1>
            <p class="page-subtitle">Tüm kullanıcıları görüntüleyin ve yönetin</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select" id="roleFilter" style="width: auto;">
                <option value="">Tüm Roller</option>
                <option value="true">Admin</option>
                <option value="false">Kullanıcı</option>
            </select>
            <button class="btn btn-outline-primary" onclick="exportUsers()">
                <i class="fas fa-download me-2"></i>Dışa Aktar
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Kullanıcılar</h5>
    </div>
    <div class="card-body">
        @if (Model != null && Model.Count() > 0)
        {
            <div class="table-responsive">
                <table class="table table-hover" id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ad Soyad</th>
                            <th>E-posta</th>
                            <th>Telefon</th>
                            <th>Rol</th>
                            <th>Kayıt Tarihi</th>
                            <th>Son Giriş</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model)
                        {
                            <tr data-role="@user.IsAdmin.ToString().ToLower()">
                                <td>@user.Id</td>
                                <td>
                                    <div>
                                        <strong>@user.FirstName @user.LastName</strong>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <span>@user.Email</span>
                                        @if (user.EmailConfirmed)
                                        {
                                            <i class="fas fa-check-circle text-success ms-1" title="E-posta onaylandı"></i>
                                        }
                                    </div>
                                </td>
                                <td>@user.Phone</td>
                                <td>
                                    @if (user.IsAdmin)
                                    {
                                        <span class="badge bg-danger">Admin</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info">Kullanıcı</span>
                                    }
                                </td>
                                <td>@user.CreatedAt.ToString("dd.MM.yyyy")</td>
                                <td>
                                    @if (user.LastLoginAt.HasValue)
                                    {
                                        <span>@user.LastLoginAt.Value.ToString("dd.MM.yyyy HH:mm")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Hiç giriş yapmamış</span>
                                    }
                                </td>
                                <td>
                                    @if (user.IsActive)
                                    {
                                        <span class="badge bg-success">Aktif</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Pasif</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewUserDetails(@user.Id)" title="Detay">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editUser(@user.Id, '@user.FirstName', '@user.LastName', '@user.Email', '@user.Phone', @user.IsAdmin.ToString().ToLower(), @user.IsActive.ToString().ToLower())" title="Düzenle">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        @if (!user.IsAdmin)
                                        {
                                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="toggleUserStatus(@user.Id, @user.IsActive.ToString().ToLower())" title="@(user.IsActive ? "Pasif Yap" : "Aktif Yap")">
                                                <i class="fas fa-@(user.IsActive ? "ban" : "check")"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Henüz kullanıcı bulunmuyor</h5>
                <p class="text-muted">Kullanıcılar kayıt olduğunda burada görünecek.</p>
            </div>
        }
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kullanıcı Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="EditUser" method="post">
                <input type="hidden" id="editUserId" name="Id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFirstName" class="form-label">Ad</label>
                                <input type="text" class="form-control" id="editFirstName" name="FirstName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLastName" class="form-label">Soyad</label>
                                <input type="text" class="form-control" id="editLastName" name="LastName" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">E-posta</label>
                        <input type="email" class="form-control" id="editEmail" name="Email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Telefon</label>
                        <input type="tel" class="form-control" id="editPhone" name="Phone">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsAdmin" name="IsAdmin" value="true">
                            <label class="form-check-label" for="editIsAdmin">
                                Admin Yetkisi
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="IsActive" value="true">
                            <label class="form-check-label" for="editIsActive">
                                Aktif
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kullanıcı Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Role filter functionality
        document.getElementById('roleFilter').addEventListener('change', function() {
            const selectedRole = this.value;
            const rows = document.querySelectorAll('#usersTable tbody tr');
            
            rows.forEach(row => {
                const role = row.getAttribute('data-role');
                if (selectedRole === '' || role === selectedRole) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        function editUser(id, firstName, lastName, email, phone, isAdmin, isActive) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editFirstName').value = firstName;
            document.getElementById('editLastName').value = lastName;
            document.getElementById('editEmail').value = email;
            document.getElementById('editPhone').value = phone;
            document.getElementById('editIsAdmin').checked = isAdmin === 'true';
            document.getElementById('editIsActive').checked = isActive === 'true';
            
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function viewUserDetails(userId) {
            // Load user details via AJAX
            fetch(`@Url.Action("UserDetails", "Admin")/${userId}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('userDetailsContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('userDetailsModal')).show();
                })
                .catch(error => {
                    console.error('Error loading user details:', error);
                    alert('Kullanıcı detayları yüklenirken bir hata oluştu.');
                });
        }

        function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'true' ? false : true;
            const action = newStatus ? 'aktif' : 'pasif';
            
            if (confirm(`Bu kullanıcıyı ${action} yapmak istediğinizden emin misiniz?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("ToggleUserStatus", "Admin")';
                
                const userIdInput = document.createElement('input');
                userIdInput.type = 'hidden';
                userIdInput.name = 'userId';
                userIdInput.value = userId;
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'isActive';
                statusInput.value = newStatus;
                
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
                
                form.appendChild(userIdInput);
                form.appendChild(statusInput);
                form.appendChild(tokenInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function exportUsers() {
            // CSV export functionality
            const table = document.getElementById('usersTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            let csv = 'ID,Ad Soyad,E-posta,Telefon,Rol,Kayıt Tarihi,Son Giriş,Durum\n';
            
            rows.slice(1).forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                const rowData = cells.map(cell => {
                    let text = cell.textContent.trim();
                    // Remove HTML tags and clean up
                    text = text.replace(/<[^>]*>/g, '');
                    text = text.replace(/\n/g, ' ');
                    text = text.replace(/,/g, ';');
                    return `"${text}"`;
                });
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `kullanicilar_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
} 